<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transigo KPI Dashboard · CSV Driven</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- PapaParse (CSV robusto con ; e quote) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#121b2e; --muted:#93a4c7; --text:#eaf0ff; --line:#223055; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,18,32,.92); backdrop-filter: blur(8px); z-index: 10;}
    nav a { color:var(--muted); margin-right:14px; text-decoration:none; }
    nav a.active { color:var(--text); font-weight:600; }
    .container { padding:16px 18px 40px; max-width:1450px; margin:0 auto; }
    .filters {
      display:grid;
      grid-template-columns: 280px 250px 360px 180px 180px 180px auto;
      gap:10px;
      align-items:end;
      padding:12px;
      background:var(--card);
      border:1px solid var(--line);
      border-radius:12px;
    }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    select, input { width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0e1730; color:var(--text); }
    .btn { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e1730; color:var(--text); cursor:pointer; }
    .grid { display:grid; gap:12px; margin-top:14px; }
    .grid.cards { grid-template-columns: repeat(4, minmax(220px, 1fr)); }
    .grid.two { grid-template-columns: 2fr 1fr; }
    .section { margin-top:18px; }
    .section h2 { font-size:16px; margin:0 0 10px; color:#d7e3ff; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .kpi-title { font-size:12px; color:var(--muted); }
    .kpi-value { font-size:26px; font-weight:700; margin-top:4px; }
    .kpi-sub { font-size:12px; color:var(--muted); margin-top:6px; }
    .chartWrap { height:290px; }
    .chartWrap.sm { height:240px; }
    canvas { width:100% !important; height:100% !important; }
    .funnel { display:grid; gap:10px; }
    .funnel-step { padding:10px; border-radius:12px; border:1px solid var(--line); background:#0e1730; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .table { overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--line); font-size:13px; color:#d7e3ff; }
    th { text-align:left; color:var(--muted); font-weight:600; }
    .muted { color: var(--muted); font-size: 12px; }
    .warn { color: #ffcc66; }
  </style>
</head>

<body>
<header>
  <div style="display:flex; gap:10px; align-items:center;">
    <strong>Transigo</strong>
    <span class="pill">KPI Monitoring · CSV Report</span>
  </div>
  <nav>
    <a href="#executive" class="active">Executive</a>
    <a href="#economica">Economica</a>
    <a href="#ops">Operations</a>
    <a href="#shortlink">ShortLink</a>
  </nav>
</header>

<div class="container">

  <!-- FILTRI GLOBALI -->
  <section class="filters" id="filters">
    <div>
      <label>1) Carica Report CSV (delimitatore ;)</label>
      <input type="file" id="fileCsv" accept=".csv" />
      <div class="muted" id="fileInfo">Nessun file caricato.</div>
    </div>

    <div>
      <label>2) Periodo (su Data Inserimento)</label>
      <input type="text" id="f-period" placeholder="YYYY-MM-DD → YYYY-MM-DD" />
      <div class="muted">Esempio: 2025-11-01 → 2025-11-29</div>
    </div>

    <div>
      <label>Cliente (Società) · multi-select</label>
      <select id="f-client" multiple></select>
      <div class="muted">Suggerimento: seleziona max 3–5 per confronti chiari</div>
    </div>

    <div>
      <label>Nazionalità</label>
      <select id="f-nation">
        <option value="">Tutti</option>
        <option value="IT">Italiani</option>
        <option value="FOREIGN">Stranieri</option>
      </select>
    </div>

    <div>
      <label>Tipo Servizio</label>
      <select id="f-service">
        <option value="">Tutti</option>
        <option value="Standard">Standard</option>
        <option value="Service Plus">Service Plus</option>
      </select>
    </div>

    <div>
      <label>Tipo Notifica</label>
      <select id="f-notify">
        <option value="">Tutti</option>
        <option value="SEND">SEND</option>
        <option value="PEC">PEC</option>
        <option value="ANALOGICA">ANALOGICA</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; justify-content:flex-end; align-items:end;">
      <button class="btn" id="btn-apply">Applica</button>
      <button class="btn" id="btn-reset">Reset</button>
    </div>
  </section>

  <div class="muted" style="margin-top:10px;">
    <span class="warn">Nota:</span> Funnel ShortLink usa proxy dal report (non ci sono eventi “open link” reali nel CSV).
  </div>

  <!-- PAGINA 1: EXECUTIVE -->
  <section class="section" id="executive">
    <h2>1) KPI Principali (Vista Executive)</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Multe gestite (righe filtrate)</div>
        <div class="kpi-value" id="kpi-cases">—</div>
        <div class="kpi-sub" id="kpi-cases-sub">IT vs Foreign: —</div>
      </div>

      <div class="card">
        <div class="kpi-title">% Conducente identificato (proxy)</div>
        <div class="kpi-value" id="kpi-identified">—</div>
        <div class="kpi-sub">Def: CF/PI/RS valorizzati</div>
      </div>

      <div class="card">
        <div class="kpi-title">% Pagate in app</div>
        <div class="kpi-value" id="kpi-paid-inapp">—</div>
        <div class="kpi-sub">Def: Data Pagamento presente</div>
      </div>

      <div class="card">
        <div class="kpi-title">Tempo medio gestione</div>
        <div class="kpi-value" id="kpi-leadtime">—</div>
        <div class="kpi-sub">Def: Inserimento → Pagamento (solo pagate)</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Trend volumi (giornaliero) · IT vs Foreign</div>
        <div class="chartWrap"><canvas id="chartExecVolumes"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">Ricavi & Take Rate (proxy margine %)</div>
        <div class="chartWrap"><canvas id="chartExecFinance"></canvas></div>
        <div class="muted">Take Rate = (Costo Gestione + OTP + Commissioni) / Totale Pagato</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Risparmio Driver (stima)</div>
        <div class="kpi-value" id="kpi-driver-saving">—</div>
        <div class="kpi-sub">Proxy: baseline_fee (7€) − fee effettiva (gestione+OTP)</div>
      </div>
      <div class="card">
        <div class="kpi-title">Trend risparmio driver (stima)</div>
        <div class="chartWrap sm"><canvas id="chartDriverSaving"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PAGINA 2: ECONOMICA -->
  <section class="section" id="economica">
    <h2>2) Rendicontazione Dealer + Flowpay (Vista Economica)</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Ricavi totali (Fee + OTP + Commissioni)</div>
        <div class="kpi-value" id="kpi-revenue">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Margine lordo € (proxy = Ricavi)</div>
        <div class="kpi-value" id="kpi-gm-eur">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Take Rate % (proxy)</div>
        <div class="kpi-value" id="kpi-gm-pct">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Pagamenti pre/post (proxy su Comunicazione Preventiva)</div>
        <div class="kpi-value" id="kpi-prepost">—</div>
        <div class="kpi-sub">pre: entro 5gg dalla Comunicazione Preventiva</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Dettaglio importi (stack) · Top clienti per volumi</div>
        <div class="chartWrap"><canvas id="chartAmountBreakdown"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">Margine % per cliente (bar)</div>
        <div class="chartWrap"><canvas id="chartMarginsByClient"></canvas></div>
      </div>
    </div>

    <div class="card table">
      <div class="kpi-title">Tabella economica per cliente (filtrata)</div>
      <table id="tbl-payments">
        <thead>
          <tr>
            <th>Cliente</th>
            <th>Pratiche</th>
            <th>Totale Pagato €</th>
            <th>Importo PA €</th>
            <th>Fee+OTP €</th>
            <th>Commissioni €</th>
            <th>Ricavi €</th>
            <th>Take Rate %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PAGINA 3: OPS -->
  <section class="section" id="ops">
    <h2>3) Performance DESK Support & Operations</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Tempo medio chiusura (Service Plus)</div>
        <div class="kpi-value" id="kpi-close-plus">—</div>
        <div class="kpi-sub">Inserimento → Pagamento</div>
      </div>
      <div class="card">
        <div class="kpi-title">Tempo medio chiusura (Standard)</div>
        <div class="kpi-value" id="kpi-close-service">—</div>
        <div class="kpi-sub">Inserimento → Pagamento</div>
      </div>
      <div class="card">
        <div class="kpi-title">Tempo medio reintestazione</div>
        <div class="kpi-value" id="kpi-reassign">—</div>
        <div class="kpi-sub">Inserimento → Rinotifica</div>
      </div>
      <div class="card">
        <div class="kpi-title">SLA pagamento (entro 72h)</div>
        <div class="kpi-value" id="kpi-sla-pay">—</div>
        <div class="kpi-sub">Comunicazione Preventiva → Pagamento</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Trend tempi chiusura (Plus vs Standard)</div>
        <div class="chartWrap"><canvas id="chartOpsClose"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">SLA: tempo medio + compliance</div>
        <div class="chartWrap"><canvas id="chartOpsSla"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PAGINA 4: SHORTLINK -->
  <section class="section" id="shortlink">
    <h2>4) Analisi Conversione & ShortLink (Comportamento Utente) · Proxy dal CSV</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Notifiche inviate (Tipo Notifica = SEND)</div>
        <div class="kpi-value" id="kpi-sent">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Delivery rate (proxy)</div>
        <div class="kpi-value" id="kpi-delivery-rate">—</div>
        <div class="kpi-sub">delivered = SEND & Stato != “Pagamento Fallito”</div>
      </div>
      <div class="card">
        <div class="kpi-title">% non hanno “aperto” (proxy)</div>
        <div class="kpi-value" id="kpi-no-open">—</div>
        <div class="kpi-sub">open = registrato o pagato o stato avanzato</div>
      </div>
      <div class="card">
        <div class="kpi-title">% open ma non registrati</div>
        <div class="kpi-value" id="kpi-open-no-reg">—</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Funnel (valori)</div>
        <div class="funnel" id="funnel">
          <div class="funnel-step">Notifica inviata: <strong id="f-step-sent">—</strong></div>
          <div class="funnel-step">Delivered (proxy): <strong id="f-step-del">—</strong></div>
          <div class="funnel-step">Link aperto (proxy): <strong id="f-step-open">—</strong></div>
          <div class="funnel-step">Registrazione App: <strong id="f-step-reg">—</strong> (Cover: <span id="f-step-cover">—</span> / On Demand: <span id="f-step-od">—</span>)</div>
          <div class="funnel-step">Pagamento: <strong id="f-step-pay">—</strong></div>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Split IT vs Foreign (Open/Reg/Pay)</div>
        <div class="chartWrap"><canvas id="chartItForeign"></canvas></div>
      </div>
    </div>
  </section>
</div>

<script>
  // -----------------------
  // Stato app
  // -----------------------
  let RAW = []; // righe del CSV
  const charts = {};

  // -----------------------
  // Utils: parsing & formatting
  // -----------------------
  const fmtInt = (n) => (n ?? 0).toLocaleString("it-IT");
  const fmtEur = (n) => (n ?? 0).toLocaleString("it-IT", { style:"currency", currency:"EUR", maximumFractionDigits:0 });
  const fmtPct = (x) => (isFinite(x) ? (x * 100).toFixed(1) : "0.0") + "%";
  const fmtHrs = (h) => (isFinite(h) ? h.toFixed(1) : "0.0") + " h";
  function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }

  function parseITDate(s) {
    // supporta dd/mm/yyyy e dd/mm/yyyy hh:mm
    if (!s) return null;
    const t = String(s).trim();
    if (!t || t === "EE") return null;
    // dd/mm/yyyy
    const m = t.match(/^(\d{2})\/(\d{2})\/(\d{4})(?:\s+(\d{2}):(\d{2}))?/);
    if (!m) return null;
    const dd = Number(m[1]), mm = Number(m[2]) - 1, yyyy = Number(m[3]);
    const hh = m[4] ? Number(m[4]) : 0;
    const mi = m[5] ? Number(m[5]) : 0;
    const d = new Date(Date.UTC(yyyy, mm, dd, hh, mi, 0));
    return isNaN(d.getTime()) ? null : d;
  }

  function parseNumberEuro(s) {
    // nel report i numeri possono arrivare "123,45" o "123.45" o vuoti
    if (s === null || s === undefined) return 0;
    const t = String(s).trim();
    if (!t || t === "EE") return 0;
    const normalized = t.replace(/\./g, "").replace(",", ".");
    const v = Number(normalized);
    return isFinite(v) ? v : 0;
  }

  function isItalian(row) {
    const code = (row["Paese Residenza"] || "").trim().toUpperCase();
    return code === "ITA" || code === "IT" || code === "ITALIA";
  }

  function getFilterState() {
    const period = (document.getElementById("f-period").value || "").trim();
    const clients = Array.from(document.getElementById("f-client").selectedOptions).map(o => o.value);
    const nation = document.getElementById("f-nation").value || "";
    const service = document.getElementById("f-service").value || "";
    const notify = document.getElementById("f-notify").value || "";
    return { period, clients, nation, service, notify };
  }

  function parsePeriod(periodStr) {
    // "YYYY-MM-DD → YYYY-MM-DD"
    if (!periodStr) return { from:null, to:null };
    const parts = periodStr.split("→").map(x => x.trim());
    if (parts.length !== 2) return { from:null, to:null };
    const from = new Date(parts[0] + "T00:00:00Z");
    const to = new Date(parts[1] + "T23:59:59Z");
    if (isNaN(from.getTime()) || isNaN(to.getTime())) return { from:null, to:null };
    return { from, to };
  }

  function inPeriod(row, from, to) {
    // periodo su Data Inserimento (come deciso in UI)
    const d = parseITDate(row["Data Inserimento"]);
    if (!d || !from || !to) return true; // se non c'è periodo valido, non filtro
    return d >= from && d <= to;
  }

  function applyFilters(rows, f) {
    const { from, to } = parsePeriod(f.period);

    return rows.filter(r => {
      if (!inPeriod(r, from, to)) return false;

      if (f.clients.length > 0) {
        const c = (r["Società"] || "").trim();
        if (!f.clients.includes(c)) return false;
      }

      if (f.nation) {
        const it = isItalian(r);
        if (f.nation === "IT" && !it) return false;
        if (f.nation === "FOREIGN" && it) return false;
      }

      if (f.service) {
        if ((r["Tipo Servizio"] || "").trim() !== f.service) return false;
      }

      if (f.notify) {
        if ((r["Tipo Notifica"] || "").trim() !== f.notify) return false;
      }

      return true;
    });
  }

  function groupBy(rows, keyFn) {
    const m = new Map();
    for (const r of rows) {
      const k = keyFn(r);
      if (!m.has(k)) m.set(k, []);
      m.get(k).push(r);
    }
    return m;
  }

  function daysKeyUTC(d) {
    // YYYY-MM-DD
    const yyyy = d.getUTCFullYear();
    const mm = String(d.getUTCMonth()+1).padStart(2,"0");
    const dd = String(d.getUTCDate()).padStart(2,"0");
    return `${yyyy}-${mm}-${dd}`;
  }

  // -----------------------
  // KPI definitions (dal CSV)
  // -----------------------
  function calcKPIs(rows) {
    const n = rows.length;

    // IT vs Foreign
    let itCount = 0;
    for (const r of rows) if (isItalian(r)) itCount++;
    const foreignCount = n - itCount;

    // Identificato (proxy): almeno uno tra CF / Partita IVA / Ragione sociale valorizzati e non "EE"
    const identified = rows.filter(r => {
      const cf = (r["Codice Fiscale"] || "").trim();
      const pi = (r["Partita Iva"] || "").trim();
      const rs = (r["Ragione sociale"] || "").trim();
      const ok = (x) => x && x !== "EE";
      return ok(cf) || ok(pi) || ok(rs);
    }).length;

    // Pagate in app (proxy): Data Pagamento presente (nel report Tipo Pagamento è "card")
    const paid = rows.filter(r => !!parseITDate(r["Data Pagamento"])).length;

    // Lead time (ore): Inserimento → Pagamento (solo pagate)
    const leadTimesHrs = [];
    for (const r of rows) {
      const di = parseITDate(r["Data Inserimento"]);
      const dp = parseITDate(r["Data Pagamento"]);
      if (di && dp && dp >= di) leadTimesHrs.push((dp - di) / 3600000);
    }
    const avgLeadHrs = leadTimesHrs.length ? leadTimesHrs.reduce((a,b)=>a+b,0)/leadTimesHrs.length : 0;

    // Ricavi: Costo Gestione Pratica + OTP + Commissioni
    let fee = 0, otp = 0, comm = 0, totalPaid = 0, importoPA = 0;
    for (const r of rows) {
      fee += parseNumberEuro(r["Costo Gestione Pratica"]);
      otp += parseNumberEuro(r["OTP"]);
      comm += parseNumberEuro(r["Commissioni"]);
      totalPaid += parseNumberEuro(r["Totale Pagato"]);
      importoPA += parseNumberEuro(r["Importo PA"]);
    }
    const revenue = fee + otp + comm;
    const takeRate = totalPaid > 0 ? revenue / totalPaid : 0;

    // Pre/Post (proxy): se Data Pagamento entro 5gg da Data ComunicazionePreventiva => pre, altrimenti post
    let pre = 0, post = 0;
    for (const r of rows) {
      const dp = parseITDate(r["Data Pagamento"]);
      if (!dp) continue;
      const dcp = parseITDate(r["Data ComunicazionePreventiva"]);
      if (!dcp) { post++; continue; } // senza comunicazione, consideriamo post/unknown
      const deltaDays = (dp - dcp) / 86400000;
      if (deltaDays <= 5) pre++; else post++;
    }

    // Risparmio driver (stima): baseline fee 7€ - (Costo Gestione + OTP), clamp >=0
    // (lo rendiamo esplicito, così lo puoi ritarare da config)
    const BASELINE_FEE = 7.0;
    let saving = 0;
    for (const r of rows) {
      const actual = parseNumberEuro(r["Costo Gestione Pratica"]) + parseNumberEuro(r["OTP"]);
      saving += Math.max(0, BASELINE_FEE - actual);
    }

    return {
      n, itCount, foreignCount,
      identifiedPct: n ? identified/n : 0,
      paidPct: n ? paid/n : 0,
      avgLeadHrs,
      revenue, fee, otp, comm, totalPaid, importoPA, takeRate,
      pre, post,
      saving
    };
  }

  // Trend giornaliero su Data Inserimento
  function trendDaily(rows) {
    const m = new Map(); // date -> {it, foreign, revenue, takeRate, saving}
    for (const r of rows) {
      const d = parseITDate(r["Data Inserimento"]);
      if (!d) continue;
      const k = daysKeyUTC(d);
      if (!m.has(k)) m.set(k, { it:0, foreign:0, revenue:0, totalPaid:0, saving:0 });
      const o = m.get(k);
      if (isItalian(r)) o.it++; else o.foreign++;

      const fee = parseNumberEuro(r["Costo Gestione Pratica"]);
      const otp = parseNumberEuro(r["OTP"]);
      const comm = parseNumberEuro(r["Commissioni"]);
      const tot = parseNumberEuro(r["Totale Pagato"]);
      o.revenue += (fee+otp+comm);
      o.totalPaid += tot;

      const BASELINE_FEE = 7.0;
      o.saving += Math.max(0, BASELINE_FEE - (fee+otp));
    }

    const labels = Array.from(m.keys()).sort();
    const it = labels.map(k => m.get(k).it);
    const foreign = labels.map(k => m.get(k).foreign);
    const revenue = labels.map(k => m.get(k).revenue);
    const takeRate = labels.map(k => {
      const o = m.get(k);
      return o.totalPaid > 0 ? (o.revenue / o.totalPaid) * 100 : 0;
    });
    const saving = labels.map(k => m.get(k).saving);

    return { labels, it, foreign, revenue, takeRate, saving };
  }

  // Tabella + grafici per cliente
  function perClient(rows) {
    const g = groupBy(rows, r => (r["Società"] || "Sconosciuto").trim() || "Sconosciuto");
    const out = [];
    for (const [client, rr] of g.entries()) {
      let fee=0, otp=0, comm=0, totalPaid=0, importoPA=0;
      for (const r of rr) {
        fee += parseNumberEuro(r["Costo Gestione Pratica"]);
        otp += parseNumberEuro(r["OTP"]);
        comm += parseNumberEuro(r["Commissioni"]);
        totalPaid += parseNumberEuro(r["Totale Pagato"]);
        importoPA += parseNumberEuro(r["Importo PA"]);
      }
      const revenue = fee + otp + comm;
      const takeRate = totalPaid > 0 ? revenue/totalPaid : 0;
      out.push({ client, cases: rr.length, totalPaid, importoPA, feeOtp: fee+otp, comm, revenue, takeRate });
    }
    // ordina per volumi desc
    out.sort((a,b) => b.cases - a.cases);
    return out;
  }

  // OPS: tempi per giorno (media), separando Standard vs Service Plus
  function opsTrends(rows) {
    // close time: Inserimento -> Pagamento, solo se pagata
    // reassign: Inserimento -> Rinotifica (se presente)
    // sla: ComunicazionePreventiva -> Pagamento (se presenti)
    const daily = new Map(); // date -> metrics
    function getDay(r) {
      const d = parseITDate(r["Data Inserimento"]);
      return d ? daysKeyUTC(d) : null;
    }
    for (const r of rows) {
      const day = getDay(r);
      if (!day) continue;
      if (!daily.has(day)) daily.set(day, {
        plusClose: [], stdClose: [],
        reassign: [],
        sla: [],
        slaOk72: 0, slaN: 0
      });
      const o = daily.get(day);

      const di = parseITDate(r["Data Inserimento"]);
      const dp = parseITDate(r["Data Pagamento"]);
      const dr = parseITDate(r["Data Rinotifica"]);
      const dcp = parseITDate(r["Data ComunicazionePreventiva"]);
      const svc = (r["Tipo Servizio"] || "").trim();

      if (di && dp && dp >= di) {
        const hrs = (dp - di)/3600000;
        if (svc === "Service Plus") o.plusClose.push(hrs);
        if (svc === "Standard") o.stdClose.push(hrs);
      }

      if (di && dr && dr >= di) {
        o.reassign.push((dr - di)/3600000);
      }

      if (dcp && dp && dp >= dcp) {
        const hrs = (dp - dcp)/3600000;
        o.sla.push(hrs);
        o.slaN += 1;
        if (hrs <= 72) o.slaOk72 += 1;
      }
    }

    const labels = Array.from(daily.keys()).sort();
    function avg(arr){ return arr.length ? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }

    const plus = labels.map(k => avg(daily.get(k).plusClose));
    const std  = labels.map(k => avg(daily.get(k).stdClose));
    const slaAvg = labels.map(k => avg(daily.get(k).sla));
    const slaComp = labels.map(k => {
      const o = daily.get(k);
      return o.slaN ? (o.slaOk72/o.slaN)*100 : 0;
    });

    return { labels, plus, std, slaAvg, slaComp };
  }

  // Shortlink Funnel (proxy dal CSV)
  function shortlinkProxy(rows) {
    // sent: Tipo Notifica = SEND
    const sentRows = rows.filter(r => (r["Tipo Notifica"] || "").trim() === "SEND");
    const sent = sentRows.length;

    // delivered proxy: SEND and Stato != "Pagamento Fallito"
    const deliveredRows = sentRows.filter(r => (r["Stato"] || "").trim() !== "Pagamento Fallito");
    const delivered = deliveredRows.length;

    // open proxy: se registrato OR pagato OR stato avanzato
    const advancedStates = new Set(["Pagata", "Chiusa", "Dichiarazione da Firmare", "Comunicazione Preventiva Inviata"]);
    const openRows = deliveredRows.filter(r => {
      const reg = (r["Registrazione App"] || "").trim() === "Si";
      const paid = !!parseITDate(r["Data Pagamento"]);
      const st = (r["Stato"] || "").trim();
      return reg || paid || advancedStates.has(st);
    });
    const open = openRows.length;

    // registrazione
    const regRows = openRows.filter(r => (r["Registrazione App"] || "").trim() === "Si");
    const reg = regRows.length;

    // cover vs on demand
    const cover = regRows.filter(r => (r["Cover"] || "").trim() === "Si").length;
    const od = reg - cover;

    // pagamento
    const pay = openRows.filter(r => !!parseITDate(r["Data Pagamento"])).length;

    // split IT vs Foreign su open/reg/pay (per chart)
    function split(arr) {
      let it=0, fr=0;
      for (const r of arr) { if (isItalian(r)) it++; else fr++; }
      return {it, fr};
    }
    const delSplit = split(deliveredRows);
    const openSplit = split(openRows);
    const regSplit = split(regRows);
    const paySplit = split(openRows.filter(r => !!parseITDate(r["Data Pagamento"])));

    return {
      sent, delivered, open, reg, cover, od, pay,
      delSplit, openSplit, regSplit, paySplit
    };
  }

  // -----------------------
  // Rendering
  // -----------------------
  function destroyChart(id) {
    if (charts[id]) { charts[id].destroy(); delete charts[id]; }
  }

  function baseOptions() {
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#eaf0ff" } } },
      scales: {
        x: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(34,48,85,.35)" } },
        y: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(34,48,85,.35)" } }
      }
    };
  }

  function renderAll() {
    const f = getFilterState();
    const rows = applyFilters(RAW, f);

    // KPI
    const k = calcKPIs(rows);
    setText("kpi-cases", fmtInt(k.n));
    setText("kpi-cases-sub", `IT ${fmtInt(k.itCount)} · Foreign ${fmtInt(k.foreignCount)}`);
    setText("kpi-identified", fmtPct(k.identifiedPct));
    setText("kpi-paid-inapp", fmtPct(k.paidPct));
    setText("kpi-leadtime", fmtHrs(k.avgLeadHrs));

    setText("kpi-revenue", fmtEur(k.revenue));
    setText("kpi-gm-eur", fmtEur(k.revenue));
    setText("kpi-gm-pct", fmtPct(k.takeRate));
    const denom = (k.pre + k.post) || 1;
    setText("kpi-prepost", `${fmtPct(k.pre/denom)} pre · ${fmtPct(k.post/denom)} post`);

    setText("kpi-driver-saving", fmtEur(k.saving));

    // Trends
    const t = trendDaily(rows);

    destroyChart("execVolumes");
    charts.execVolumes = new Chart(document.getElementById("chartExecVolumes"), {
      type: "bar",
      data: { labels: t.labels, datasets: [
        { label: "Italiani", data: t.it, stack: "s1" },
        { label: "Stranieri", data: t.foreign, stack: "s1" }
      ]},
      options: {
        ...baseOptions(),
        scales: { x:{ stacked:true, ticks:{color:"#93a4c7"}, grid:{color:"rgba(34,48,85,.35)"} },
                  y:{ stacked:true, ticks:{color:"#93a4c7"}, grid:{color:"rgba(34,48,85,.35)"} } }
      }
    });

    destroyChart("execFinance");
    charts.execFinance = new Chart(document.getElementById("chartExecFinance"), {
      type: "line",
      data: { labels: t.labels, datasets: [
        { label: "Ricavi (€)", data: t.revenue, yAxisID: "y" },
        { label: "Take Rate (%)", data: t.takeRate, yAxisID: "y1" }
      ]},
      options: {
        ...baseOptions(),
        scales: {
          x: { ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { position:"left", ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y1:{ position:"right", ticks:{ color:"#93a4c7" }, grid:{ drawOnChartArea:false } }
        }
      }
    });

    destroyChart("driverSaving");
    charts.driverSaving = new Chart(document.getElementById("chartDriverSaving"), {
      type: "bar",
      data: { labels: t.labels, datasets: [{ label: "Risparmio Driver (stima €)", data: t.saving }] },
      options: baseOptions()
    });

    // Economica per cliente
    const pc = perClient(rows);

    // Breakdown top 5 per volumi: stack ImportoPA vs Fee+OTP vs Comm (solo per lettura veloce)
    const top = pc.slice(0, 5);
    const labelsTop = top.map(x => x.client);
    const importoPA = top.map(x => x.importoPA);
    const feeOtp = top.map(x => x.feeOtp);
    const comm = top.map(x => x.comm);

    destroyChart("amountBreakdown");
    charts.amountBreakdown = new Chart(document.getElementById("chartAmountBreakdown"), {
      type: "bar",
      data: { labels: labelsTop, datasets: [
        { label: "Importo PA (€)", data: importoPA, stack: "s2" },
        { label: "Fee + OTP (€)", data: feeOtp, stack: "s2" },
        { label: "Commissioni (€)", data: comm, stack: "s2" },
      ]},
      options: {
        ...baseOptions(),
        scales: { x:{ stacked:true, ticks:{color:"#93a4c7"}, grid:{color:"rgba(34,48,85,.35)"} },
                  y:{ stacked:true, ticks:{color:"#93a4c7"}, grid:{color:"rgba(34,48,85,.35)"} } }
      }
    });

    destroyChart("marginsByClient");
    charts.marginsByClient = new Chart(document.getElementById("chartMarginsByClient"), {
      type: "bar",
      data: { labels: pc.slice(0, 10).map(x => x.client),
              datasets: [{ label: "Take Rate (%)", data: pc.slice(0, 10).map(x => x.takeRate*100) }] },
      options: baseOptions()
    });

    // Tabella per cliente
    const tbody = document.querySelector("#tbl-payments tbody");
    tbody.innerHTML = "";
    for (const r of pc) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.client}</td>
        <td>${fmtInt(r.cases)}</td>
        <td>${fmtEur(r.totalPaid)}</td>
        <td>${fmtEur(r.importoPA)}</td>
        <td>${fmtEur(r.feeOtp)}</td>
        <td>${fmtEur(r.comm)}</td>
        <td>${fmtEur(r.revenue)}</td>
        <td>${fmtPct(r.takeRate)}</td>
      `;
      tbody.appendChild(tr);
    }

    // OPS
    const ot = opsTrends(rows);
    const plusAvg = ot.plus.filter(x => x>0);
    const stdAvg = ot.std.filter(x => x>0);
    const slaAvg = ot.slaAvg.filter(x => x>0);
    const closePlus = plusAvg.length ? plusAvg.reduce((a,b)=>a+b,0)/plusAvg.length : 0;
    const closeStd = stdAvg.length ? stdAvg.reduce((a,b)=>a+b,0)/stdAvg.length : 0;
    const slaMean = slaAvg.length ? slaAvg.reduce((a,b)=>a+b,0)/slaAvg.length : 0;
    const compMean = ot.slaComp.length ? ot.slaComp.reduce((a,b)=>a+b,0)/ot.slaComp.length : 0;

    // reassign mean (non giornaliero, calcolo veloce)
    let reassignArr = [];
    for (const r of rows) {
      const di = parseITDate(r["Data Inserimento"]);
      const dr = parseITDate(r["Data Rinotifica"]);
      if (di && dr && dr >= di) reassignArr.push((dr-di)/3600000);
    }
    const reassignMean = reassignArr.length ? reassignArr.reduce((a,b)=>a+b,0)/reassignArr.length : 0;

    setText("kpi-close-plus", fmtHrs(closePlus));
    setText("kpi-close-service", fmtHrs(closeStd));
    setText("kpi-reassign", fmtHrs(reassignMean));
    setText("kpi-sla-pay", (isFinite(compMean) ? compMean.toFixed(1) : "0.0") + "%");

    destroyChart("opsClose");
    charts.opsClose = new Chart(document.getElementById("chartOpsClose"), {
      type: "line",
      data: { labels: ot.labels, datasets: [
        { label: "Chiusura Service Plus (h)", data: ot.plus },
        { label: "Chiusura Standard (h)", data: ot.std }
      ]},
      options: baseOptions()
    });

    destroyChart("opsSla");
    charts.opsSla = new Chart(document.getElementById("chartOpsSla"), {
      type: "line",
      data: { labels: ot.labels, datasets: [
        { label: "Tempo medio pagamento post comunicazione (h)", data: ot.slaAvg, yAxisID:"y" },
        { label: "Compliance SLA 72h (%)", data: ot.slaComp, yAxisID:"y1" }
      ]},
      options: {
        ...baseOptions(),
        scales: {
          x: { ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { position:"left", ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y1:{ position:"right", ticks:{ color:"#93a4c7" }, grid:{ drawOnChartArea:false } }
        }
      }
    });

    // Shortlink proxy
    const s = shortlinkProxy(rows);
    setText("kpi-sent", fmtInt(s.sent));
    setText("kpi-delivery-rate", fmtPct(s.sent ? s.delivered/s.sent : 0));
    setText("kpi-no-open", fmtPct(s.delivered ? (s.delivered - s.open)/s.delivered : 0));
    setText("kpi-open-no-reg", fmtPct(s.open ? (s.open - s.reg)/s.open : 0));

    setText("f-step-sent", fmtInt(s.sent));
    setText("f-step-del", fmtInt(s.delivered));
    setText("f-step-open", fmtInt(s.open));
    setText("f-step-reg", fmtInt(s.reg));
    setText("f-step-cover", fmtInt(s.cover));
    setText("f-step-od", fmtInt(s.od));
    setText("f-step-pay", fmtInt(s.pay));

    destroyChart("itForeign");
    const itOpenRate = s.delSplit.it ? (s.openSplit.it / s.delSplit.it) * 100 : 0;
    const frOpenRate = s.delSplit.fr ? (s.openSplit.fr / s.delSplit.fr) * 100 : 0;
    const itRegRate = s.openSplit.it ? (s.regSplit.it / s.openSplit.it) * 100 : 0;
    const frRegRate = s.openSplit.fr ? (s.regSplit.fr / s.openSplit.fr) * 100 : 0;
    const itPayRate = s.regSplit.it ? (s.paySplit.it / s.regSplit.it) * 100 : 0;
    const frPayRate = s.regSplit.fr ? (s.paySplit.fr / s.regSplit.fr) * 100 : 0;

    charts.itForeign = new Chart(document.getElementById("chartItForeign"), {
      type: "bar",
      data: {
        labels: ["Open Rate", "Registration Rate", "Payment Rate"],
        datasets: [
          { label: "Italiani", data: [itOpenRate, itRegRate, itPayRate] },
          { label: "Stranieri", data: [frOpenRate, frRegRate, frPayRate] }
        ]
      },
      options: baseOptions()
    });
  }

  // -----------------------
  // CSV load
  // -----------------------
  function populateClients(rows) {
    const sel = document.getElementById("f-client");
    sel.innerHTML = "";
    const clients = Array.from(new Set(rows.map(r => (r["Società"] || "").trim()).filter(Boolean))).sort();
    for (const c of clients) {
      const opt = document.createElement("option");
      opt.value = c; opt.textContent = c;
      sel.appendChild(opt);
    }
  }

  document.getElementById("fileCsv").addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    document.getElementById("fileInfo").textContent = `Caricato: ${file.name} (${Math.round(file.size/1024)} KB)`;

    Papa.parse(file, {
      header: true,
      skipEmptyLines: true,
      delimiter: ";",
      complete: (res) => {
        // pulizia: rimuovi righe totalmente vuote
        RAW = (res.data || []).filter(r => r && Object.values(r).some(v => String(v ?? "").trim() !== ""));
        populateClients(RAW);

        // suggerisci periodo automaticamente (min/max Data Inserimento)
        const dates = RAW.map(r => parseITDate(r["Data Inserimento"])).filter(Boolean).sort((a,b)=>a-b);
        if (dates.length) {
          const min = dates[0], max = dates[dates.length-1];
          const f = (d) => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${String(d.getUTCDate()).padStart(2,"0")}`;
          document.getElementById("f-period").value = `${f(min)} → ${f(max)}`;
        }

        renderAll();
      },
      error: (err) => {
        alert("Errore parsing CSV: " + err.message);
      }
    });
  });

  // Buttons
  document.getElementById("btn-apply").addEventListener("click", () => {
    if (!RAW.length) return alert("Carica prima un CSV.");
    renderAll();
  });

  document.getElementById("btn-reset").addEventListener("click", () => {
    location.reload();
  });
</script>

</body>
</html>
