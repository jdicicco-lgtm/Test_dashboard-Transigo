<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transigo KPI Dashboard (Demo)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --bg:#0b1220; --card:#121b2e; --muted:#93a4c7; --text:#eaf0ff; --line:#223055; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
    header { display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:rgba(11,18,32,.92); backdrop-filter: blur(8px); z-index: 10;}
    nav a { color:var(--muted); margin-right:14px; text-decoration:none; }
    nav a.active { color:var(--text); font-weight:600; }
    .container { padding:16px 18px 40px; max-width:1400px; margin:0 auto; }
    .filters { display:grid; grid-template-columns: 220px 360px 160px 180px auto; gap:10px; align-items:end; padding:12px; background:var(--card); border:1px solid var(--line); border-radius:12px; }
    label { font-size:12px; color:var(--muted); display:block; margin-bottom:6px; }
    select, input { width:100%; padding:10px; border-radius:10px; border:1px solid var(--line); background:#0e1730; color:var(--text); }
    .btn { padding:10px 12px; border-radius:10px; border:1px solid var(--line); background:#0e1730; color:var(--text); cursor:pointer; }
    .grid { display:grid; gap:12px; margin-top:14px; }
    .grid.cards { grid-template-columns: repeat(4, minmax(220px, 1fr)); }
    .grid.two { grid-template-columns: 2fr 1fr; }
    .section { margin-top:18px; }
    .section h2 { font-size:16px; margin:0 0 10px; color:#d7e3ff; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:12px; padding:12px; }
    .kpi-title { font-size:12px; color:var(--muted); }
    .kpi-value { font-size:26px; font-weight:700; margin-top:4px; }
    .kpi-sub { font-size:12px; color:var(--muted); margin-top:6px; }
    .chartWrap { height:290px; }
    .chartWrap.sm { height:240px; }
    canvas { width:100% !important; height:100% !important; }
    .funnel { display:grid; gap:10px; }
    .funnel-step { padding:10px; border-radius:12px; border:1px solid var(--line); background:#0e1730; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .table { overflow:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:10px; border-bottom:1px solid var(--line); font-size:13px; color:#d7e3ff; }
    th { text-align:left; color:var(--muted); font-weight:600; }
  </style>
</head>

<body>
<header>
  <div style="display:flex; gap:10px; align-items:center;">
    <strong>Transigo</strong>
    <span class="pill">KPI Monitoring · Demo Data</span>
  </div>
  <nav>
    <a href="#executive" class="active">Executive</a>
    <a href="#economica">Economica</a>
    <a href="#ops">Operations</a>
    <a href="#shortlink">ShortLink</a>
  </nav>
</header>

<div class="container">

  <!-- FILTRI GLOBALI -->
  <section class="filters" id="filters">
    <div>
      <label>Periodo</label>
      <input type="text" id="f-period" placeholder="2025-12-01 → 2025-12-31" value="2025-12-01 → 2025-12-31" />
    </div>

    <div>
      <label>Cliente (Noleggiatore)</label>
      <select id="f-client" multiple>
        <option value="Vivarent">Vivarent</option>
        <option value="BuyFleet">BuyFleet</option>
        <option value="Rental Plus">Rental Plus</option>
        <option value="WayCar - TurismoSanVitoLoCapo">WayCar - TurismoSanVitoLoCapo</option>
        <option value="Italy Car Rent">Italy Car Rent</option>
        <option value="All Rent | U-SAVE">All Rent | U-SAVE</option>
        <option value="Differental - ITA RENT S.r.l.">Differental - ITA RENT S.r.l.</option>
        <option value="Stairway Rent S.r.l">Stairway Rent S.r.l</option>
        <option value="Etna Rent S.a.S.">Etna Rent S.a.S.</option>
        <option value="Clarent S.r.l.">Clarent S.r.l.</option>
      </select>
    </div>

    <div>
      <label>Canale</label>
      <select id="f-channel">
        <option value="">Tutti</option>
        <option value="B2B">B2B</option>
        <option value="B2C">B2C</option>
      </select>
    </div>

    <div>
      <label>Nazionalità</label>
      <select id="f-nation">
        <option value="">Tutti</option>
        <option value="IT">Italiani</option>
        <option value="FOREIGN">Stranieri</option>
      </select>
    </div>

    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="btn" id="btn-apply">Applica</button>
      <button class="btn" id="btn-reset">Reset</button>
    </div>
  </section>

  <!-- PAGINA 1: EXECUTIVE -->
  <section class="section" id="executive">
    <h2>1) KPI Principali (Vista Executive)</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Multe gestite (periodo)</div>
        <div class="kpi-value" id="kpi-cases">—</div>
        <div class="kpi-sub" id="kpi-cases-sub">IT vs Foreign: —</div>
      </div>
      <div class="card">
        <div class="kpi-title">% Conducente identificato</div>
        <div class="kpi-value" id="kpi-identified">—</div>
        <div class="kpi-sub">identified / cases</div>
      </div>
      <div class="card">
        <div class="kpi-title">% Pagate in app</div>
        <div class="kpi-value" id="kpi-paid-inapp">—</div>
        <div class="kpi-sub">paid_in_app / cases_eligible</div>
      </div>
      <div class="card">
        <div class="kpi-title">Tempo medio gestione</div>
        <div class="kpi-value" id="kpi-leadtime">—</div>
        <div class="kpi-sub">infrazione → azione utente</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Trend volumi (stack IT/Foreign)</div>
        <div class="chartWrap"><canvas id="chartExecVolumes"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">Ricavi & Margine (linee)</div>
        <div class="chartWrap"><canvas id="chartExecFinance"></canvas></div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Risparmio Driver (totale)</div>
        <div class="kpi-value" id="kpi-driver-saving">—</div>
        <div class="kpi-sub">Σ max(0, baseline_cost - actual_cost)</div>
      </div>
      <div class="card">
        <div class="kpi-title">Trend risparmio driver</div>
        <div class="chartWrap sm"><canvas id="chartDriverSaving"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PAGINA 2: ECONOMICA -->
  <section class="section" id="economica">
    <h2>2) Rendicontazione Dealer + Flowpay (Vista Economica)</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Ricavi totali (fee + commissioni)</div>
        <div class="kpi-value" id="kpi-revenue">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Margine lordo €</div>
        <div class="kpi-value" id="kpi-gm-eur">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Margine lordo %</div>
        <div class="kpi-value" id="kpi-gm-pct">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Pagamenti pre/post sollecito (split)</div>
        <div class="kpi-value" id="kpi-prepost">—</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Dettaglio importi (stack)</div>
        <div class="chartWrap"><canvas id="chartAmountBreakdown"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">“Heatmap proxy” margini per Cliente</div>
        <div class="chartWrap"><canvas id="chartMarginsByClient"></canvas></div>
      </div>
    </div>

    <div class="card table">
      <div class="kpi-title">Tabella riconciliazione pagamenti (demo)</div>
      <table id="tbl-payments">
        <thead>
          <tr>
            <th>Cliente</th><th>Transazioni</th><th>Incassato €</th><th>Fee €</th><th>Commissioni €</th><th>Margine %</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- PAGINA 3: OPS -->
  <section class="section" id="ops">
    <h2>3) Performance DESK Support & Operations</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Tempo medio chiusura (Plus)</div>
        <div class="kpi-value" id="kpi-close-plus">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Tempo medio chiusura (Service)</div>
        <div class="kpi-value" id="kpi-close-service">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Tempo medio reintestazione</div>
        <div class="kpi-value" id="kpi-reassign">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">SLA pagamento (entro 72h)</div>
        <div class="kpi-value" id="kpi-sla-pay">—</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Trend tempi (Plus vs Service)</div>
        <div class="chartWrap"><canvas id="chartOpsClose"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">SLA: tempo medio pagamento + compliance</div>
        <div class="chartWrap"><canvas id="chartOpsSla"></canvas></div>
      </div>
    </div>
  </section>

  <!-- PAGINA 4: SHORTLINK -->
  <section class="section" id="shortlink">
    <h2>4) Analisi Conversione & ShortLink (Comportamento Utente)</h2>

    <div class="grid cards">
      <div class="card">
        <div class="kpi-title">Notifiche inviate</div>
        <div class="kpi-value" id="kpi-sent">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">Delivery rate</div>
        <div class="kpi-value" id="kpi-delivery-rate">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">% non hanno aperto</div>
        <div class="kpi-value" id="kpi-no-open">—</div>
      </div>
      <div class="card">
        <div class="kpi-title">% open ma non registrati</div>
        <div class="kpi-value" id="kpi-open-no-reg">—</div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Funnel conversione (valori)</div>
        <div class="funnel" id="funnel">
          <div class="funnel-step">Notifica inviata: <strong id="f-step-sent">—</strong></div>
          <div class="funnel-step">Delivered: <strong id="f-step-del">—</strong></div>
          <div class="funnel-step">Link aperto: <strong id="f-step-open">—</strong></div>
          <div class="funnel-step">Registrazione: <strong id="f-step-reg">—</strong> (Cover: <span id="f-step-cover">—</span> / On Demand: <span id="f-step-od">—</span>)</div>
          <div class="funnel-step">Firma: <strong id="f-step-sign">—</strong></div>
          <div class="funnel-step">Pagamento: <strong id="f-step-pay">—</strong></div>
        </div>
      </div>
      <div class="card">
        <div class="kpi-title">Trend conversion rates</div>
        <div class="chartWrap"><canvas id="chartShortlinkRates"></canvas></div>
      </div>
    </div>

    <div class="grid two">
      <div class="card">
        <div class="kpi-title">Drop-off per step (bar)</div>
        <div class="chartWrap"><canvas id="chartDropoff"></canvas></div>
      </div>
      <div class="card">
        <div class="kpi-title">Split IT vs Foreign (Open/Reg/Pay)</div>
        <div class="chartWrap"><canvas id="chartItForeign"></canvas></div>
      </div>
    </div>
  </section>
</div>

<script>
  // -----------------------
  // Mock data (demo)
  // -----------------------
  const CLIENTS = [
    "Vivarent",
    "BuyFleet",
    "Rental Plus",
    "WayCar - TurismoSanVitoLoCapo",
    "Italy Car Rent",
    "All Rent | U-SAVE",
    "Differental - ITA RENT S.r.l.",
    "Stairway Rent S.r.l",
    "Etna Rent S.a.S.",
    "Clarent S.r.l."
  ];

  const demo = {
    labels: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14"],

    volumes: {
      it:     [38, 41, 44, 39, 47, 52, 49, 55, 58, 53, 60, 63, 59, 64],
      foreign:[22, 25, 28, 24, 30, 33, 31, 35, 37, 34, 39, 41, 38, 42],
    },

    identifiedPct: [0.62,0.63,0.64,0.63,0.65,0.66,0.67,0.66,0.68,0.69,0.70,0.70,0.71,0.72],
    paidInAppPct:  [0.31,0.32,0.33,0.33,0.34,0.36,0.35,0.37,0.38,0.38,0.39,0.40,0.41,0.42],

    finance: {
      revenue: [4200, 4500, 4700, 4600, 5100, 5600, 5400, 5900, 6200, 6000, 6600, 6900, 6700, 7200],
      gmPct:   [0.41, 0.40, 0.42, 0.41, 0.43, 0.44, 0.43, 0.45, 0.46, 0.45, 0.47, 0.48, 0.47, 0.49]
    },

    driverSaving: [620, 680, 710, 690, 760, 820, 790, 870, 910, 880, 950, 980, 960, 1030],

    // Economica: breakdown su subset (3) per non affollare
    amountBreakdown: {
      labels: ["Vivarent", "BuyFleet", "Rental Plus"],
      sanction:  [52000, 39000, 21000],
      appFees:   [ 8200,  6400,  3300],
      handling:  [ 6100,  5200,  2900],
    },

    // Economica: margine per cliente (proxy heatmap)
    marginsByClient: {
      labels: CLIENTS,
      gmPct: [0.46,0.41,0.44,0.38,0.49,0.42,0.40,0.45,0.43,0.47]
    },

    // Tabella pagamenti per cliente (demo)
    paymentsTable: [
      {client:"Vivarent", tx:220, gross:18200, fee:3100, comm:1100, gmPct:0.46},
      {client:"BuyFleet", tx:160, gross:14100, fee:2400, comm:900,  gmPct:0.41},
      {client:"Rental Plus", tx:140, gross:12100, fee:2100, comm:700, gmPct:0.44},
      {client:"WayCar - TurismoSanVitoLoCapo", tx:90, gross:8200, fee:1400, comm:600, gmPct:0.38},
      {client:"Italy Car Rent", tx:120, gross:9900, fee:1700, comm:500, gmPct:0.49},
      {client:"All Rent | U-SAVE", tx:110, gross:9100, fee:1600, comm:500, gmPct:0.42},
      {client:"Differental - ITA RENT S.r.l.", tx:130, gross:10800, fee:1900, comm:650, gmPct:0.40},
      {client:"Stairway Rent S.r.l", tx:105, gross:8700, fee:1500, comm:520, gmPct:0.45},
      {client:"Etna Rent S.a.S.", tx:115, gross:9400, fee:1600, comm:550, gmPct:0.43},
      {client:"Clarent S.r.l.", tx:150, gross:12600, fee:2200, comm:700, gmPct:0.47},
    ],

    ops: {
      closePlusHrs:   [29, 30, 31, 30, 28, 27, 26, 27, 25, 26, 24, 24, 23, 22],
      closeServHrs:   [44, 45, 46, 45, 43, 42, 41, 42, 40, 39, 38, 38, 37, 36],
      paymentLeadHrs: [80, 78, 76, 74, 72, 70, 68, 69, 66, 65, 63, 62, 60, 59],
      sla72Compliance:[0.54,0.55,0.56,0.57,0.58,0.60,0.61,0.62,0.64,0.65,0.66,0.67,0.68,0.69],
      reassignHrs:    [18, 19, 18, 17, 16, 16, 15, 15, 14, 14, 13, 13, 12, 12]
    },

    shortlink: {
      sent:  1200,
      del:   1090,
      open:   730,
      reg:    460,
      cover:  310,
      od:     150,
      sign:   390,
      pay:    340,

      openRate: [0.64,0.65,0.63,0.66,0.67,0.68,0.66,0.69,0.70,0.68,0.71,0.72,0.71,0.73],
      regRate:  [0.61,0.60,0.62,0.63,0.62,0.64,0.63,0.65,0.66,0.64,0.66,0.67,0.66,0.68],
      payRate:  [0.73,0.74,0.72,0.75,0.75,0.76,0.75,0.77,0.78,0.77,0.79,0.80,0.79,0.81],

      it:      {del: 640, open: 450, reg: 300, pay: 230},
      foreign: {del: 450, open: 280, reg: 160, pay: 110},
    }
  };

  // -----------------------
  // Helpers (format)
  // -----------------------
  const fmtInt = (n) => (n ?? 0).toLocaleString("it-IT");
  const fmtEur = (n) => (n ?? 0).toLocaleString("it-IT", { style:"currency", currency:"EUR", maximumFractionDigits:0 });
  const fmtPct = (x) => ((x ?? 0) * 100).toFixed(1) + "%";
  const fmtHrs = (h) => (h ?? 0).toFixed(1) + " h";
  function setText(id, v) { const el = document.getElementById(id); if (el) el.textContent = v; }

  // -----------------------
  // KPI Cards (demo)
  // -----------------------
  function renderKpis() {
    const totalIT = demo.volumes.it.reduce((a,b)=>a+b,0);
    const totalFR = demo.volumes.foreign.reduce((a,b)=>a+b,0);
    const totalCases = totalIT + totalFR;

    const identifiedAvg = demo.identifiedPct.reduce((a,b)=>a+b,0) / demo.identifiedPct.length;
    const paidAvg = demo.paidInAppPct.reduce((a,b)=>a+b,0) / demo.paidInAppPct.length;
    const leadTimeAvgHrs = demo.ops.paymentLeadHrs.reduce((a,b)=>a+b,0) / demo.ops.paymentLeadHrs.length; // proxy

    setText("kpi-cases", fmtInt(totalCases));
    setText("kpi-cases-sub", `IT ${fmtInt(totalIT)} · Foreign ${fmtInt(totalFR)}`);
    setText("kpi-identified", fmtPct(identifiedAvg));
    setText("kpi-paid-inapp", fmtPct(paidAvg));
    setText("kpi-leadtime", fmtHrs(leadTimeAvgHrs));

    const revenueTotal = demo.finance.revenue.reduce((a,b)=>a+b,0);
    const gmAvg = demo.finance.gmPct.reduce((a,b)=>a+b,0) / demo.finance.gmPct.length;
    setText("kpi-revenue", fmtEur(revenueTotal));
    setText("kpi-gm-eur", fmtEur(revenueTotal * gmAvg));
    setText("kpi-gm-pct", fmtPct(gmAvg));

    const pre = 0.58, post = 0.42; // demo
    setText("kpi-prepost", `${fmtPct(pre)} pre · ${fmtPct(post)} post`);

    const savingTotal = demo.driverSaving.reduce((a,b)=>a+b,0);
    setText("kpi-driver-saving", fmtEur(savingTotal));

    // OPS
    const closePlusAvg = demo.ops.closePlusHrs.reduce((a,b)=>a+b,0) / demo.ops.closePlusHrs.length;
    const closeServAvg = demo.ops.closeServHrs.reduce((a,b)=>a+b,0) / demo.ops.closeServHrs.length;
    const reassignAvg  = demo.ops.reassignHrs.reduce((a,b)=>a+b,0) / demo.ops.reassignHrs.length;
    const slaAvg       = demo.ops.sla72Compliance.reduce((a,b)=>a+b,0) / demo.ops.sla72Compliance.length;

    setText("kpi-close-plus", fmtHrs(closePlusAvg));
    setText("kpi-close-service", fmtHrs(closeServAvg));
    setText("kpi-reassign", fmtHrs(reassignAvg));
    setText("kpi-sla-pay", fmtPct(slaAvg));

    // Shortlink KPI
    const s = demo.shortlink;
    setText("kpi-sent", fmtInt(s.sent));
    setText("kpi-delivery-rate", fmtPct(s.del / s.sent));
    setText("kpi-no-open", fmtPct((s.del - s.open) / s.del));
    setText("kpi-open-no-reg", fmtPct((s.open - s.reg) / s.open));

    setText("f-step-sent", fmtInt(s.sent));
    setText("f-step-del", fmtInt(s.del));
    setText("f-step-open", fmtInt(s.open));
    setText("f-step-reg", fmtInt(s.reg));
    setText("f-step-cover", fmtInt(s.cover));
    setText("f-step-od", fmtInt(s.od));
    setText("f-step-sign", fmtInt(s.sign));
    setText("f-step-pay", fmtInt(s.pay));
  }

  // -----------------------
  // Charts
  // -----------------------
  const charts = {};
  function baseOptions() {
    return {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: "#eaf0ff" } } },
      scales: {
        x: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(34,48,85,.35)" } },
        y: { ticks: { color: "#93a4c7" }, grid: { color: "rgba(34,48,85,.35)" } }
      }
    };
  }

  function renderCharts() {
    charts.execVolumes = new Chart(document.getElementById("chartExecVolumes"), {
      type: "bar",
      data: { labels: demo.labels, datasets: [
        { label: "Italiani", data: demo.volumes.it, stack: "s1" },
        { label: "Stranieri", data: demo.volumes.foreign, stack: "s1" }
      ]},
      options: {
        ...baseOptions(),
        scales: {
          x: { stacked:true, ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { stacked:true, ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } }
        }
      }
    });

    charts.execFinance = new Chart(document.getElementById("chartExecFinance"), {
      type: "line",
      data: { labels: demo.labels, datasets: [
        { label: "Ricavi (€)", data: demo.finance.revenue, yAxisID: "y" },
        { label: "Margine Lordo (%)", data: demo.finance.gmPct.map(x=>x*100), yAxisID: "y1" }
      ]},
      options: {
        ...baseOptions(),
        scales: {
          x: { ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { position:"left", ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y1:{ position:"right", ticks:{ color:"#93a4c7" }, grid:{ drawOnChartArea:false } }
        }
      }
    });

    charts.driverSaving = new Chart(document.getElementById("chartDriverSaving"), {
      type: "bar",
      data: { labels: demo.labels, datasets: [{ label: "Risparmio Driver (€)", data: demo.driverSaving }] },
      options: baseOptions()
    });

    charts.amountBreakdown = new Chart(document.getElementById("chartAmountBreakdown"), {
      type: "bar",
      data: {
        labels: demo.amountBreakdown.labels,
        datasets: [
          { label: "Importo sanzioni (€)", data: demo.amountBreakdown.sanction, stack: "s2" },
          { label: "Servizi app (OTP + comm.) (€)", data: demo.amountBreakdown.appFees, stack: "s2" },
          { label: "Gestione pratiche (€)", data: demo.amountBreakdown.handling, stack: "s2" }
        ]
      },
      options: {
        ...baseOptions(),
        scales: {
          x: { stacked:true, ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { stacked:true, ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } }
        }
      }
    });

    charts.marginsByClient = new Chart(document.getElementById("chartMarginsByClient"), {
      type: "bar",
      data: {
        labels: demo.marginsByClient.labels,
        datasets: [{ label: "Margine Lordo (%)", data: demo.marginsByClient.gmPct.map(x=>x*100) }]
      },
      options: baseOptions()
    });

    charts.opsClose = new Chart(document.getElementById("chartOpsClose"), {
      type: "line",
      data: { labels: demo.labels, datasets: [
        { label: "Chiusura Plus (h)", data: demo.ops.closePlusHrs },
        { label: "Chiusura Service (h)", data: demo.ops.closeServHrs }
      ]},
      options: baseOptions()
    });

    charts.opsSla = new Chart(document.getElementById("chartOpsSla"), {
      type: "line",
      data: { labels: demo.labels, datasets: [
        { label: "Tempo pagamento (h)", data: demo.ops.paymentLeadHrs, yAxisID:"y" },
        { label: "Compliance SLA 72h (%)", data: demo.ops.sla72Compliance.map(x=>x*100), yAxisID:"y1" }
      ]},
      options: {
        ...baseOptions(),
        scales: {
          x: { ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y: { position:"left", ticks:{ color:"#93a4c7" }, grid:{ color:"rgba(34,48,85,.35)" } },
          y1:{ position:"right", ticks:{ color:"#93a4c7" }, grid:{ drawOnChartArea:false } }
        }
      }
    });

    charts.shortlinkRates = new Chart(document.getElementById("chartShortlinkRates"), {
      type: "line",
      data: { labels: demo.labels, datasets: [
        { label: "Open Rate (%)", data: demo.shortlink.openRate.map(x=>x*100) },
        { label: "Registration Rate (%)", data: demo.shortlink.regRate.map(x=>x*100) },
        { label: "Payment Rate (%)", data: demo.shortlink.payRate.map(x=>x*100) }
      ]},
      options: baseOptions()
    });

    const s = demo.shortlink;
    const drop = {
      "Sent→Delivered": 1 - (s.del/s.sent),
      "Delivered→Open": 1 - (s.open/s.del),
      "Open→Reg": 1 - (s.reg/s.open),
      "Reg→Sign": 1 - (s.sign/s.reg),
      "Sign→Pay": 1 - (s.pay/s.sign),
    };
    charts.dropoff = new Chart(document.getElementById("chartDropoff"), {
      type: "bar",
      data: { labels: Object.keys(drop), datasets: [{ label: "Drop-off (%)", data: Object.values(drop).map(x=>x*100) }] },
      options: baseOptions()
    });

    charts.itForeign = new Chart(document.getElementById("chartItForeign"), {
      type: "bar",
      data: {
        labels: ["Open", "Registrazione", "Pagamento"],
        datasets: [
          {
            label: "Italiani",
            data: [
              demo.shortlink.it.open / demo.shortlink.it.del * 100,
              demo.shortlink.it.reg / demo.shortlink.it.open * 100,
              demo.shortlink.it.pay / demo.shortlink.it.reg * 100
            ]
          },
          {
            label: "Stranieri",
            data: [
              demo.shortlink.foreign.open / demo.shortlink.foreign.del * 100,
              demo.shortlink.foreign.reg / demo.shortlink.foreign.open * 100,
              demo.shortlink.foreign.pay / demo.shortlink.foreign.reg * 100
            ]
          }
        ]
      },
      options: baseOptions()
    });
  }

  // -----------------------
  // Table (demo)
  // -----------------------
  function renderPaymentsTable() {
    const tbody = document.querySelector("#tbl-payments tbody");
    tbody.innerHTML = "";
    for (const r of demo.paymentsTable) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.client}</td>
        <td>${fmtInt(r.tx)}</td>
        <td>${fmtEur(r.gross)}</td>
        <td>${fmtEur(r.fee)}</td>
        <td>${fmtEur(r.comm)}</td>
        <td>${fmtPct(r.gmPct)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // Init
  renderKpis();
  renderPaymentsTable();
  renderCharts();

  // Demo buttons
  document.getElementById("btn-apply").addEventListener("click", () => {
    alert("Demo: qui collegherai le chiamate API / ricalcolo KPI in base ai filtri (client multi-select incluso).");
  });
  document.getElementById("btn-reset").addEventListener("click", () => location.reload());
</script>

</body>
</html>
